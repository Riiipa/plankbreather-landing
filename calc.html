import React, { useState, useEffect } from 'react';
import { Calculator, Home, Euro, TrendingUp, AlertCircle, Info, PieChart, Wallet, Users, Banknote, TrendingDown, LineChart } from 'lucide-react';

const RealEstateCalculator = () => {
  // --- STATE: Вхідні дані ---
  
  // 1. Об'єкт
  const [price, setPrice] = useState(150000);
  const [area, setArea] = useState(19);
  const [works, setWorks] = useState(10000); // Ремонт + Меблі
  
  // 2. Фінансування
  const [contribution, setContribution] = useState(25000); // Власний внесок
  const [rate, setRate] = useState(3.7); // Відсоткова ставка
  const [duration, setDuration] = useState(20); // Років
  const [insuranceRate, setInsuranceRate] = useState(0.35); // Страховка позичальника

  // 3. Експлуатація (Місячні/Річні дані)
  const [rent, setRent] = useState(750); // Оренда
  const [chargesCopro, setChargesCopro] = useState(70); // Комунальні (доля власника)
  const [taxeFonciere, setTaxeFonciere] = useState(600); // Податок на рік
  const [pno, setPno] = useState(150); // Страховка PNO на рік
  const [accountant, setAccountant] = useState(250); // Бухгалтер на рік (LMNP)
  const [vacancyRate, setVacancyRate] = useState(5); // % простою (ризик)

  // 4. Альтернативні інвестиції (ROI)
  const [sp500Rate, setSp500Rate] = useState(8); // S&P 500 historical
  const [techRate, setTechRate] = useState(12); // Tech conservative

  // --- РОЗРАХУНКИ ---

  // Витрати на купівлю
  const notaryFees = price * 0.08; // ~8% для старого житла
  const totalProjectCost = price + works + notaryFees;
  const loanAmount = totalProjectCost - contribution;

  // Кредит (Щомісячний платіж)
  const monthlyRate = rate / 100 / 12;
  const numberOfPayments = duration * 12;
  const monthlyMortgage = loanAmount > 0 
    ? (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1) 
    : 0;
  
  const monthlyInsurance = (loanAmount * (insuranceRate / 100)) / 12;
  const totalMonthlyLoan = monthlyMortgage + monthlyInsurance;

  // Витрати щомісячні (усереднені)
  const monthlyTaxeFonciere = taxeFonciere / 12;
  const monthlyPNO = pno / 12;
  const monthlyAccountant = accountant / 12;
  const monthlyVacancy = rent * (vacancyRate / 100);
  const managementFee = 0; 

  const totalMonthlyExpenses = chargesCopro + monthlyTaxeFonciere + monthlyPNO + monthlyAccountant + managementFee + monthlyVacancy;

  // CASH FLOW (Щомісячний)
  const totalOutflow = totalMonthlyLoan + totalMonthlyExpenses;
  const cashFlow = rent - totalOutflow;

  // --- РОЗРАХУНКИ ЗА ВЕСЬ ПЕРІОД (LIFETIME) ---
  const totalMonths = duration * 12;
  
  // 1. Скільки реально заплатить орендар (Net Rent)
  const totalTenantPaid = (rent - monthlyVacancy) * totalMonths;

  // 2. Повна вартість операції за 20 років
  const monthlyExpensesRealCash = chargesCopro + monthlyTaxeFonciere + monthlyPNO + monthlyAccountant + managementFee;
  const totalLifetimeCost = contribution + (totalMonthlyLoan * totalMonths) + (monthlyExpensesRealCash * totalMonths);

  // 3. Частка інвестора
  const totalInvestorPaid = totalLifetimeCost - totalTenantPaid;

  // 4. Переплата банку (Вартість кредиту)
  const totalLoanRepayment = totalMonthlyLoan * totalMonths;
  const costOfCredit = totalLoanRepayment - loanAmount;

  // Відсотки для графіка
  const percentTenant = Math.min(100, Math.max(0, (totalTenantPaid / totalLifetimeCost) * 100));
  const percentInvestor = 100 - percentTenant;

  // Рентабельність
  const grossYield = (rent * 12 / totalProjectCost) * 100;

  // --- АЛЬТЕРНАТИВНІ ІНВЕСТИЦІЇ (Opportunity Cost) ---
  
  // Щомісячна інвестиція в акції = Ваш "мінус" по квартирі (доплата).
  // Якщо квартира в плюсі, вважаємо, що ви просто інвестуєте початковий внесок, а monthly = 0 (спрощення).
  const monthlyInvestAlternative = Math.max(0, -cashFlow); 
  
  // Функція складного відсотка з поповненням
  const calculateCompoundInterest = (principal: number, monthly: number, rate: number, years: number) => {
    const r = rate / 100 / 12;
    const n = years * 12;
    const futureValuePrincipal = principal * Math.pow(1 + r, n);
    const futureValueSeries = monthly * (Math.pow(1 + r, n) - 1) / r;
    return futureValuePrincipal + futureValueSeries;
  };

  const finalValueSP500 = calculateCompoundInterest(contribution, monthlyInvestAlternative, sp500Rate, duration);
  const finalValueTech = calculateCompoundInterest(contribution, monthlyInvestAlternative, techRate, duration);
  
  // Майбутня вартість квартири (при інфляції 2%)
  const realEstateAppreciationRate = 2; // 2% conservative appreciation for Paris
  const finalValueRealEstate = price * Math.pow(1 + (realEstateAppreciationRate/100), duration);

  return (
    <div className="max-w-4xl mx-auto p-4 bg-gray-50 rounded-xl font-sans text-gray-800">
      <div className="flex items-center gap-2 mb-6 border-b pb-4 border-gray-200">
        <Home className="text-blue-600 w-8 h-8" />
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Калькулятор Інвестора (LMNP)</h1>
          <p className="text-sm text-gray-500">Симуляція: Нерухомість vs Акції</p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        
        {/* --- ЛІВА КОЛОНКА --- */}
        <div className="space-y-6">
          
          {/* Секція 1: Купівля */}
          <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
            <h3 className="text-md font-semibold text-blue-800 mb-4 flex items-center gap-2">
              <Calculator size={18}/> Вартість Проекту
            </h3>
            <div className="space-y-3">
              <div>
                <label className="text-xs font-medium text-gray-500 uppercase">Ціна квартири (€)</label>
                <input 
                  type="number" 
                  value={price} 
                  onChange={(e) => setPrice(Number(e.target.value))}
                  className="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition"
                />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs font-medium text-gray-500 uppercase">Ремонт/Меблі (€)</label>
                  <input 
                    type="number" 
                    value={works} 
                    onChange={(e) => setWorks(Number(e.target.value))}
                    className="w-full mt-1 p-2 border rounded-md"
                  />
                </div>
                <div>
                  <label className="text-xs font-medium text-gray-500 uppercase">Нотаріус (8%)</label>
                  <div className="w-full mt-1 p-2 bg-gray-100 rounded-md text-gray-600">
                    {notaryFees.toLocaleString()} €
                  </div>
                </div>
              </div>
              <div className="pt-2 border-t flex justify-between items-center">
                <span className="font-semibold text-sm">Повна вартість:</span>
                <span className="font-bold text-lg text-blue-900">{totalProjectCost.toLocaleString()} €</span>
              </div>
            </div>
          </div>

          {/* Секція 2: Фінансування */}
          <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
            <h3 className="text-md font-semibold text-blue-800 mb-4 flex items-center gap-2">
              <Euro size={18}/> Фінансування
            </h3>
            <div className="space-y-3">
              <div>
                <label className="text-xs font-medium text-gray-500 uppercase">Ваш внесок (Apport) (€)</label>
                <input 
                  type="number" 
                  value={contribution} 
                  onChange={(e) => setContribution(Number(e.target.value))}
                  className="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                />
              </div>
              <div className="grid grid-cols-3 gap-3">
                <div className="col-span-1">
                  <label className="text-xs font-medium text-gray-500 uppercase">Ставка %</label>
                  <input 
                    type="number" step="0.01"
                    value={rate} 
                    onChange={(e) => setRate(Number(e.target.value))}
                    className="w-full mt-1 p-2 border rounded-md"
                  />
                </div>
                <div className="col-span-1">
                  <label className="text-xs font-medium text-gray-500 uppercase">Років</label>
                  <input 
                    type="number" 
                    value={duration} 
                    onChange={(e) => setDuration(Number(e.target.value))}
                    className="w-full mt-1 p-2 border rounded-md"
                  />
                </div>
                <div className="col-span-1">
                   <label className="text-xs font-medium text-gray-500 uppercase">Страховка %</label>
                   <input 
                    type="number" step="0.01"
                    value={insuranceRate} 
                    onChange={(e) => setInsuranceRate(Number(e.target.value))}
                    className="w-full mt-1 p-2 border rounded-md"
                  />
                </div>
              </div>
              <div className="p-3 bg-blue-50 rounded-md flex justify-between items-center border border-blue-100">
                <span className="text-sm text-blue-800 font-medium">Кредитний платіж:</span>
                <span className="font-bold text-blue-900">{totalMonthlyLoan.toFixed(0)} €/міс</span>
              </div>
            </div>
          </div>

          {/* Секція 3: Доходи та Витрати */}
          <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
            <h3 className="text-md font-semibold text-blue-800 mb-4 flex items-center gap-2">
              <TrendingUp size={18}/> Операційна діяльність
            </h3>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs font-medium text-green-600 uppercase">Оренда (на місяць)</label>
                <input 
                  type="number" 
                  value={rent} 
                  onChange={(e) => setRent(Number(e.target.value))}
                  className="w-full mt-1 p-2 border border-green-200 bg-green-50 rounded-md font-semibold text-green-800"
                />
              </div>
              <div>
                <label className="text-xs font-medium text-red-500 uppercase">Комунальні (Charges)</label>
                <input 
                  type="number" 
                  value={chargesCopro} 
                  onChange={(e) => setChargesCopro(Number(e.target.value))}
                  className="w-full mt-1 p-2 border rounded-md"
                />
              </div>
              <div>
                <label className="text-xs font-medium text-red-500 uppercase">Taxe Foncière (рік)</label>
                <input 
                  type="number" 
                  value={taxeFonciere} 
                  onChange={(e) => setTaxeFonciere(Number(e.target.value))}
                  className="w-full mt-1 p-2 border rounded-md"
                />
              </div>
              <div>
                <label className="text-xs font-medium text-red-500 uppercase">Інше (PNO/Бух) рік</label>
                <input 
                  type="number" 
                  value={pno + accountant} 
                  onChange={(e) => setPno(Number(e.target.value))}
                  className="w-full mt-1 p-2 border rounded-md"
                />
              </div>
            </div>
          </div>

        </div>

        {/* --- ПРАВА КОЛОНКА --- */}
        <div className="space-y-6">
          
          {/* CASH FLOW */}
          <div className={`p-6 rounded-xl shadow-md text-white ${cashFlow >= 0 ? 'bg-green-600' : 'bg-slate-800'}`}>
            <h2 className="text-sm font-medium opacity-80 uppercase tracking-wider mb-1">Щомісячний Cash Flow</h2>
            <div className="flex items-baseline gap-2">
              <span className="text-5xl font-bold">{cashFlow > 0 ? '+' : ''}{cashFlow.toFixed(0)} €</span>
              <span className="text-lg opacity-80">/ міс</span>
            </div>
            <p className="mt-4 text-sm opacity-90 flex items-start gap-2">
              <Info size={16} className="mt-1 flex-shrink-0" />
              {cashFlow < 0 
                ? "Це ваша доплата щомісяця (Effort d'épargne)." 
                : "Вітаємо! Квартира окупає себе сама."}
            </p>
          </div>

          {/* ДЕТАЛІЗАЦІЯ ВИТРАТ */}
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Куди йдуть гроші (щомісяця)</h3>
            
            <div className="space-y-3">
              <div className="flex justify-between items-center pb-2 border-b border-gray-100">
                <span className="text-green-700 font-semibold">Оренда (Дохід)</span>
                <span className="text-green-700 font-bold">+ {rent} €</span>
              </div>
              <div className="flex justify-between items-center text-sm">
                <span className="text-gray-600 pl-2 border-l-2 border-blue-500">Кредит + Страховка</span>
                <span className="text-red-500 font-medium">- {totalMonthlyLoan.toFixed(0)} €</span>
              </div>
              <div className="flex justify-between items-center text-sm">
                <span className="text-gray-600 pl-2 border-l-2 border-orange-400">Комунальні + Податки</span>
                <span className="text-red-500 font-medium">- {(chargesCopro + monthlyTaxeFonciere).toFixed(0)} €</span>
              </div>
              <div className="flex justify-between items-center text-sm">
                <span className="text-gray-600 pl-2 border-l-2 border-yellow-400">Резерв (Простій + Ремонт)</span>
                <span className="text-red-500 font-medium">- {(monthlyVacancy + rent*0.05).toFixed(0)} €</span>
              </div>
              <div className="pt-3 mt-2 border-t flex justify-between items-center font-bold">
                <span className="text-gray-800">Всього витрат</span>
                <span className="text-red-600">- {totalOutflow.toFixed(0)} €</span>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
             <div className="bg-blue-50 p-4 rounded-lg text-center">
               <div className="text-xs text-blue-600 uppercase font-semibold mb-1">Брутто прибутковість</div>
               <div className="text-2xl font-bold text-blue-900">{grossYield.toFixed(2)}%</div>
             </div>
             <div className="bg-purple-50 p-4 rounded-lg text-center">
               <div className="text-xs text-purple-600 uppercase font-semibold mb-1">Кредитне плече</div>
               <div className="text-2xl font-bold text-purple-900">{((loanAmount/totalProjectCost)*100).toFixed(0)}%</div>
             </div>
          </div>

        </div>
      </div>

      {/* --- СЕКЦІЯ: ПІДСУМОК ЗА ВЕСЬ ЧАС --- */}
      <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-8">
        <div className="bg-gray-900 p-4 flex items-center gap-3">
           <PieChart className="text-green-400" />
           <h2 className="text-white text-lg font-bold">Підсумок за {duration} років: Хто платить за банкет?</h2>
        </div>
        
        <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
          
          {/* Графік */}
          <div className="md:col-span-1 flex flex-col items-center justify-center">
             <div className="w-full h-8 bg-blue-900 rounded-full overflow-hidden flex relative shadow-inner">
                <div 
                  className="h-full bg-green-500 flex items-center justify-center text-xs font-bold text-white transition-all duration-1000" 
                  style={{ width: `${percentTenant}%` }}
                >
                  {percentTenant.toFixed(0)}%
                </div>
                <div className="h-full flex items-center justify-center text-xs font-bold text-white flex-1">
                  {percentInvestor.toFixed(0)}%
                </div>
             </div>
             <div className="flex justify-between w-full mt-2 text-sm font-semibold">
                <span className="text-green-600">Орендар</span>
                <span className="text-blue-900">Ви</span>
             </div>
          </div>

          {/* Цифри */}
          <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
             
             {/* Орендар */}
             <div className="p-4 bg-green-50 rounded-lg border border-green-100 relative">
               <div className="absolute top-4 right-4 text-green-200"><Users size={24} /></div>
               <p className="text-xs text-green-600 uppercase font-bold">Оплачено Орендарем</p>
               <p className="text-2xl font-bold text-green-800 mt-1">{totalTenantPaid.toLocaleString()} €</p>
               <p className="text-xs text-green-600 mt-2">
                 Всі орендні платежі за {duration} років.
               </p>
             </div>

             {/* Інвестор */}
             <div className="p-4 bg-blue-50 rounded-lg border border-blue-100 relative">
               <div className="absolute top-4 right-4 text-blue-200"><Wallet size={24} /></div>
               <p className="text-xs text-blue-600 uppercase font-bold">Оплачено Вами</p>
               <p className="text-2xl font-bold text-blue-900 mt-1">{totalInvestorPaid.toLocaleString()} €</p>
               <p className="text-xs text-blue-500 mt-2">
                 Ваш внесок + всі щомісячні доплати.
               </p>
             </div>

             {/* НОВИЙ БЛОК: ПЕРЕПЛАТА */}
             <div className="col-span-1 sm:col-span-2 mt-2 p-4 bg-red-50 rounded-lg border border-red-100 relative">
               <div className="flex gap-4 items-center">
                 <div className="p-2 bg-red-100 rounded-full text-red-600 hidden sm:block">
                    <Banknote size={24} />
                 </div>
                 <div>
                    <p className="text-sm font-semibold text-red-800 mb-1">Ціна грошей (Переплата)</p>
                    <p className="text-xs text-gray-600 mb-2">
                        За {duration} років ви заплатите банку <span className="font-bold text-red-700">{costOfCredit.toLocaleString()} €</span> відсотків та страховки.
                    </p>
                    <div className="text-xs bg-white bg-opacity-60 p-2 rounded border border-red-200 inline-block">
                        Це <span className="font-bold">+{((costOfCredit / price) * 100).toFixed(0)}%</span> до вартості квартири.
                    </div>
                 </div>
               </div>
             </div>
          </div>
        </div>
      </div>

       {/* --- СЕКЦІЯ: ПОРІВНЯННЯ СТРАТЕГІЙ (NEW) --- */}
       <div className="bg-gradient-to-br from-indigo-900 to-slate-900 rounded-xl shadow-lg border border-indigo-800 overflow-hidden">
        <div className="p-6 border-b border-indigo-800 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
           <div>
             <h2 className="text-white text-xl font-bold flex items-center gap-2">
               <LineChart className="text-yellow-400" />
               Битва Стратегій: Що краще через {duration} років?
             </h2>
             <p className="text-indigo-200 text-sm mt-1">
               Що, якби ви вклали ті ж гроші ({contribution.toLocaleString()}€ + {monthlyInvestAlternative.toFixed(0)}€/міс) в акції?
             </p>
           </div>
           
           <div className="flex gap-4 text-xs">
             <div>
               <label className="text-indigo-300 block mb-1">Дохідність S&P500</label>
               <input 
                 type="number" value={sp500Rate} onChange={e => setSp500Rate(Number(e.target.value))}
                 className="bg-indigo-950 text-white border border-indigo-700 rounded p-1 w-20 text-center"
               /> %
             </div>
             <div>
               <label className="text-indigo-300 block mb-1">Дохідність Tech</label>
               <input 
                 type="number" value={techRate} onChange={e => setTechRate(Number(e.target.value))}
                 className="bg-indigo-950 text-white border border-indigo-700 rounded p-1 w-20 text-center"
               /> %
             </div>
           </div>
        </div>
        
        <div className="p-8">
           <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end h-64">
              
              {/* 1. REAL ESTATE */}
              <div className="flex flex-col justify-end h-full group">
                 <div className="text-center mb-2">
                   <span className="text-indigo-200 text-sm font-semibold uppercase tracking-wider block mb-1">Нерухомість</span>
                   <span className="text-white text-2xl font-bold">{finalValueRealEstate.toLocaleString(undefined, {maximumFractionDigits: 0})} €</span>
                   <span className="text-xs text-indigo-400 block">Вартість активу (+2%/рік)</span>
                 </div>
                 <div className="w-full bg-blue-600 rounded-t-lg relative transition-all duration-500 hover:bg-blue-500" 
                      style={{height: `${(finalValueRealEstate / Math.max(finalValueRealEstate, finalValueSP500, finalValueTech)) * 100}%`}}>
                      <div className="absolute bottom-2 w-full text-center text-blue-200 text-xs font-mono">Стабільно</div>
                 </div>
              </div>

              {/* 2. S&P 500 */}
              <div className="flex flex-col justify-end h-full group">
                 <div className="text-center mb-2">
                   <span className="text-indigo-200 text-sm font-semibold uppercase tracking-wider block mb-1">S&P 500</span>
                   <span className="text-white text-2xl font-bold">{finalValueSP500.toLocaleString(undefined, {maximumFractionDigits: 0})} €</span>
                   <span className="text-xs text-indigo-400 block">При {sp500Rate}% річних</span>
                 </div>
                 <div className="w-full bg-yellow-500 rounded-t-lg relative transition-all duration-500 hover:bg-yellow-400" 
                      style={{height: `${(finalValueSP500 / Math.max(finalValueRealEstate, finalValueSP500, finalValueTech)) * 100}%`}}>
                      <div className="absolute bottom-2 w-full text-center text-yellow-900 text-xs font-mono">Пасивно</div>
                 </div>
              </div>

              {/* 3. TECH STOCKS */}
              <div className="flex flex-col justify-end h-full group">
                 <div className="text-center mb-2">
                   <span className="text-indigo-200 text-sm font-semibold uppercase tracking-wider block mb-1">Ваші Акції</span>
                   <span className="text-white text-2xl font-bold">{finalValueTech.toLocaleString(undefined, {maximumFractionDigits: 0})} €</span>
                   <span className="text-xs text-indigo-400 block">При {techRate}% (консервативно)</span>
                 </div>
                 <div className="w-full bg-purple-600 rounded-t-lg relative transition-all duration-500 hover:bg-purple-500" 
                      style={{height: `${(finalValueTech / Math.max(finalValueRealEstate, finalValueSP500, finalValueTech)) * 100}%`}}>
                      <div className="absolute bottom-2 w-full text-center text-purple-200 text-xs font-mono">Ризиково</div>
                 </div>
              </div>

           </div>
           
           <div className="mt-8 p-4 bg-indigo-950/50 rounded-lg border border-indigo-800 text-indigo-200 text-sm text-center">
             <Info size={16} className="inline mr-2 mb-1"/>
             Увага: Ці розрахунки не враховують податки на приріст капіталу (Flat Tax 30% для акцій) та податки при продажу квартири (які зменшуються з часом). 
             Нерухомість також дає можливість жити в ній або мати стабільний дохід після виплати кредиту.
           </div>
        </div>
      </div>

    </div>
  );
};

export default RealEstateCalculator;
