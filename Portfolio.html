<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій Портфель (Pro Tracker)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; color: #1e293b; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom scrollbar for table */
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Початкові дані (завантажуються, якщо LocalStorage порожній)
        const SEED_PORTFOLIO = [
            { id: 1, ticker: "GOOGL", name: "Alphabet Inc", qty: 8, avgPrice: 165.82, sector: "Communication" },
            { id: 2, ticker: "AMAT", name: "Applied Materials", qty: 5, avgPrice: 198.29, sector: "Technology" },
            { id: 3, ticker: "WDC", name: "Western Digital", qty: 3, avgPrice: 30.75, sector: "Technology" },
            { id: 4, ticker: "QCOM", name: "Qualcomm Inc", qty: 2, avgPrice: 136.28, sector: "Technology" },
            { id: 5, ticker: "NVDA", name: "NVIDIA Corp", qty: 3, avgPrice: 134.52, sector: "Technology" },
            { id: 6, ticker: "TSM", name: "Taiwan Semi", qty: 5, avgPrice: 90.83, sector: "Technology" }
        ];

        const SEED_WATCHLIST = [
            { id: 101, ticker: "MSFT", name: "Microsoft", targetPrice: 400.00, sector: "Software" },
            { id: 102, ticker: "AAPL", name: "Apple Inc", targetPrice: 200.00, sector: "Electronics" },
            { id: 103, ticker: "AMD", name: "AMD Inc", targetPrice: 180.00, sector: "Semiconductors" }
        ];

        // --- КОМПОНЕНТИ ІНТЕРФЕЙСУ ---

        const Icon = ({ name, size = 18, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const formatMoney = (val) => val ? val.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }) : '-';
        const formatNumber = (val) => val ? val.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) : '-';

        // --- ГОЛОВНИЙ ДОДАТОК ---

        const App = () => {
            // --- STATE ---
            // Дані активів (зберігаються локально)
            const [portfolio, setPortfolio] = useState(() => {
                const saved = localStorage.getItem('my_portfolio_v2');
                return saved ? JSON.parse(saved) : SEED_PORTFOLIO;
            });
            const [watchlist, setWatchlist] = useState(() => {
                const saved = localStorage.getItem('my_watchlist_v2');
                return saved ? JSON.parse(saved) : SEED_WATCHLIST;
            });

            // Ринкові дані (не зберігаються, оновлюються з мережі)
            const [prices, setPrices] = useState({});
            
            // UI State
            const [view, setView] = useState("holdings"); // holdings | watchlist
            const [isLoading, setIsLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);
            
            // Modals
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null); // null = create new
            const [formData, setFormData] = useState({ ticker: "", name: "", qty: "", price: "", type: "holdings", sector: "" });

            // --- ЕФЕКТИ (Збереження та завантаження) ---

            useEffect(() => {
                localStorage.setItem('my_portfolio_v2', JSON.stringify(portfolio));
            }, [portfolio]);

            useEffect(() => {
                localStorage.setItem('my_watchlist_v2', JSON.stringify(watchlist));
            }, [watchlist]);

            useEffect(() => {
                fetchMarketData(); // Авто-оновлення цін при старті
            }, []);

            // --- ЛОГІКА: ОТРИМАННЯ ЦІН (YAHOO FINANCE API) ---
            const fetchMarketData = async () => {
                setIsLoading(true);
                
                // Збираємо всі унікальні тікери
                const allTickers = [
                    ...new Set([
                        ...portfolio.map(i => i.ticker), 
                        ...watchlist.map(i => i.ticker)
                    ])
                ];

                if (allTickers.length === 0) {
                    setIsLoading(false);
                    return;
                }

                try {
                    // Використовуємо corsproxy.io для обходу CORS при запиті до Yahoo
                    // Або використовуємо фінансовий API (наприклад, Finnhub або AlphaVantage - у безкоштовних версіях є ліміти)
                    // Для надійності тут я емулюю запит до API, який повертає реалістичні дані,
                    // АЛЕ в реальному проекті ви б вставили сюди виклик `fetch('https://query1.finance.yahoo.com/v8/finance/chart/AAPL?interval=1d')`
                    
                    // Щоб це працювало "з коробки" без API ключів, ми використаємо трюк:
                    // Yahoo Finance Query API (неофіційний, але працює) через проксі "allorigins"
                    
                    const promises = allTickers.map(async (ticker) => {
                        try {
                            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d`;
                            // Використовуємо проксі, бо Yahoo не дозволяє запити з браузера напряму
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                            
                            const response = await fetch(proxyUrl);
                            const data = await response.json();
                            const yahooData = JSON.parse(data.contents);
                            
                            if (yahooData.chart && yahooData.chart.result) {
                                const meta = yahooData.chart.result[0].meta;
                                return {
                                    ticker: ticker,
                                    price: meta.regularMarketPrice,
                                    prevClose: meta.previousClose
                                };
                            }
                        } catch (e) {
                            console.warn(`Failed to fetch ${ticker}`, e);
                            return null;
                        }
                    });

                    const results = await Promise.all(promises);
                    const newPrices = {};
                    
                    results.forEach(res => {
                        if (res) {
                            newPrices[res.ticker] = res.price;
                        }
                    });

                    // Якщо API не спрацював (через блокування проксі), використовуємо Fallback на попередні ціни або мок-дані
                    // Для демо я залишу старі ціни, якщо нові не прийшли
                    setPrices(prev => ({...prev, ...newPrices}));
                    setLastUpdated(new Date());

                } catch (e) {
                    console.error("Market data fetch error", e);
                    alert("Помилка оновлення даних. Yahoo API може бути тимчасово недоступним через проксі.");
                } finally {
                    setIsLoading(false);
                }
            };

            // --- CRUD (Create, Update, Delete) ---

            const handleSaveAsset = () => {
                if (!formData.ticker) return;

                const newItem = {
                    id: editingItem ? editingItem.id : Date.now(),
                    ticker: formData.ticker.toUpperCase(),
                    name: formData.name || formData.ticker.toUpperCase(),
                    sector: formData.sector || "Other",
                    // Для портфеля
                    qty: parseFloat(formData.qty) || 0,
                    avgPrice: parseFloat(formData.price) || 0,
                    // Для вотчліста
                    targetPrice: parseFloat(formData.price) || 0
                };

                const targetList = formData.type === 'holdings' ? portfolio : watchlist;
                const setTargetList = formData.type === 'holdings' ? setPortfolio : setWatchlist;

                if (editingItem) {
                    // Update
                    setTargetList(targetList.map(item => item.id === newItem.id ? newItem : item));
                } else {
                    // Create
                    setTargetList([...targetList, newItem]);
                }

                closeModal();
                // Оновити ціну для нового тікера
                if (!editingItem) fetchMarketData();
            };

            const handleDelete = (id, type) => {
                if (confirm("Видалити цей актив?")) {
                    if (type === 'holdings') {
                        setPortfolio(portfolio.filter(i => i.id !== id));
                    } else {
                        setWatchlist(watchlist.filter(i => i.id !== id));
                    }
                }
            };

            const openAddModal = (type) => {
                setEditingItem(null);
                setFormData({ ticker: "", name: "", qty: "", price: "", type: type, sector: "" });
                setIsModalOpen(true);
            };

            const openEditModal = (item, type) => {
                setEditingItem(item);
                setFormData({
                    ticker: item.ticker,
                    name: item.name,
                    sector: item.sector,
                    qty: item.qty || "",
                    price: type === 'holdings' ? item.avgPrice : item.targetPrice,
                    type: type
                });
                setIsModalOpen(true);
            };

            const closeModal = () => setIsModalOpen(false);

            // --- РОЗРАХУНКИ ---
            const totalValue = portfolio.reduce((acc, item) => acc + (item.qty * (prices[item.ticker] || item.avgPrice)), 0);
            const totalCost = portfolio.reduce((acc, item) => acc + (item.qty * item.avgPrice), 0);
            const totalGain = totalValue - totalCost;
            const totalGainPercent = totalCost > 0 ? (totalGain / totalCost) * 100 : 0;

            // --- РЕНДЕР ТАБЛИЦІ ПОРТФЕЛЯ ---
            const renderPortfolioTable = () => (
                <div className="overflow-x-auto custom-scroll">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0 z-10 border-b border-slate-200">
                            <tr>
                                <th className="p-4 font-semibold">Символ</th>
                                <th className="p-4 font-semibold text-right">Ціна</th>
                                <th className="p-4 font-semibold text-right hidden sm:table-cell">Кількість</th>
                                <th className="p-4 font-semibold text-right hidden md:table-cell">Сер. Вхід</th>
                                <th className="p-4 font-semibold text-right">Вартість</th>
                                <th className="p-4 font-semibold text-right">Прибуток (Total)</th>
                                <th className="p-4 font-semibold text-center w-24">Дії</th>
                            </tr>
                        </thead>
                        <tbody className="text-sm divide-y divide-slate-100 bg-white">
                            {portfolio.map(item => {
                                const currPrice = prices[item.ticker] || item.avgPrice; // Fallback to avg price if no live data
                                const marketVal = item.qty * currPrice;
                                const costBasis = item.qty * item.avgPrice;
                                const gain = marketVal - costBasis;
                                const gainPct = (gain / costBasis) * 100;
                                
                                return (
                                    <tr key={item.id} className="hover:bg-slate-50 transition-colors group">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-900">{item.ticker}</div>
                                            <div className="text-xs text-slate-500">{item.name}</div>
                                        </td>
                                        <td className="p-4 text-right font-medium text-blue-600">{formatNumber(currPrice)}</td>
                                        <td className="p-4 text-right text-slate-600 hidden sm:table-cell">{item.qty}</td>
                                        <td className="p-4 text-right text-slate-600 hidden md:table-cell">{formatNumber(item.avgPrice)}</td>
                                        <td className="p-4 text-right font-bold text-slate-900">{formatNumber(marketVal)}</td>
                                        <td className="p-4 text-right">
                                            <div className={gain >= 0 ? "text-green-600 font-medium" : "text-red-600 font-medium"}>
                                                {gain >= 0 ? '+' : ''}{formatNumber(gain)}
                                            </div>
                                            <div className={`text-xs ${gain >= 0 ? "text-green-600" : "text-red-600"} bg-opacity-10 px-1 rounded inline-block mt-1 ${gain >= 0 ? "bg-green-100" : "bg-red-100"}`}>
                                                {gainPct.toFixed(2)}%
                                            </div>
                                        </td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => openEditModal(item, 'holdings')} className="text-blue-600 hover:text-blue-800 p-1"><Icon name="pencil" size={14}/></button>
                                                <button onClick={() => handleDelete(item.id, 'holdings')} className="text-red-400 hover:text-red-600 p-1"><Icon name="trash-2" size={14}/></button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );

            // --- РЕНДЕР WATCHLIST ---
            const renderWatchlistTable = () => (
                <div className="overflow-x-auto custom-scroll">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0 z-10 border-b border-slate-200">
                            <tr>
                                <th className="p-4 font-semibold">Символ</th>
                                <th className="p-4 font-semibold text-right">Поточна Ціна</th>
                                <th className="p-4 font-semibold text-right">Цільова Ціна</th>
                                <th className="p-4 font-semibold text-right">До цілі</th>
                                <th className="p-4 font-semibold text-center w-24">Дії</th>
                            </tr>
                        </thead>
                        <tbody className="text-sm divide-y divide-slate-100 bg-white">
                            {watchlist.map(item => {
                                const currPrice = prices[item.ticker] || 0;
                                const dist = currPrice > 0 ? ((item.targetPrice - currPrice) / currPrice) * 100 : 0;
                                const isClose = dist > 0 && dist < 5; // Менше 5% до цілі

                                return (
                                    <tr key={item.id} className="hover:bg-slate-50 transition-colors group">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-900">{item.ticker}</div>
                                            <div className="text-xs text-slate-500">{item.name}</div>
                                        </td>
                                        <td className="p-4 text-right font-medium text-blue-600">{currPrice > 0 ? formatNumber(currPrice) : '-'}</td>
                                        <td className="p-4 text-right text-slate-600">{formatNumber(item.targetPrice)}</td>
                                        <td className="p-4 text-right">
                                            {currPrice > 0 && (
                                                <span className={`px-2 py-1 rounded text-xs font-medium ${isClose ? 'bg-green-100 text-green-700 animate-pulse' : dist < 0 ? 'text-green-600' : 'text-slate-500'}`}>
                                                    {dist.toFixed(2)}%
                                                </span>
                                            )}
                                        </td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => openEditModal(item, 'watchlist')} className="text-blue-600 hover:text-blue-800 p-1"><Icon name="pencil" size={14}/></button>
                                                <button onClick={() => handleDelete(item.id, 'watchlist')} className="text-red-400 hover:text-red-600 p-1"><Icon name="trash-2" size={14}/></button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50">
                    {/* Header Section */}
                    <div className="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex flex-col md:flex-row justify-between items-center py-4 gap-4">
                                
                                {/* Logo & Main Stats */}
                                <div className="flex items-center gap-6 w-full md:w-auto">
                                    <div className="font-bold text-xl text-slate-900 flex items-center gap-2">
                                        <div className="bg-purple-600 text-white p-1.5 rounded"><Icon name="pie-chart" size={20}/></div>
                                        MyFinance
                                    </div>
                                    <div className="h-8 w-px bg-slate-200 hidden md:block"></div>
                                    <div className="flex gap-6">
                                        <div>
                                            <div className="text-xs text-slate-500 uppercase font-semibold">Вартість портфеля</div>
                                            <div className="text-lg font-bold text-slate-900">{formatMoney(totalValue)}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-slate-500 uppercase font-semibold">Загальний прибуток</div>
                                            <div className={`text-lg font-bold flex items-center gap-1 ${totalGain >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {totalGain >= 0 ? '+' : ''}{formatNumber(totalGain)} 
                                                <span className="text-sm font-normal bg-opacity-10 bg-current px-1.5 rounded-md">
                                                    {totalGainPercent.toFixed(2)}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Controls */}
                                <div className="flex items-center gap-3 w-full md:w-auto justify-end">
                                    <div className="text-xs text-slate-400 hidden sm:block">
                                        Дані: {lastUpdated ? lastUpdated.toLocaleTimeString() : '...'}
                                    </div>
                                    <button 
                                        onClick={fetchMarketData} 
                                        className={`p-2 rounded-full hover:bg-slate-100 text-slate-500 transition ${isLoading ? 'animate-spin' : ''}`}
                                        title="Оновити ціни (API)"
                                    >
                                        <Icon name="refresh-cw" size={18}/>
                                    </button>
                                    <button 
                                        onClick={() => openAddModal(view)} 
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-sm"
                                    >
                                        <Icon name="plus" size={16}/> Додати символ
                                    </button>
                                </div>
                            </div>

                            {/* Tabs */}
                            <div className="flex gap-6 mt-2">
                                <button 
                                    onClick={() => setView('holdings')} 
                                    className={`pb-3 text-sm font-medium transition border-b-2 ${view === 'holdings' ? 'border-purple-600 text-purple-700' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                                >
                                    Активи (Holdings)
                                </button>
                                <button 
                                    onClick={() => setView('watchlist')} 
                                    className={`pb-3 text-sm font-medium transition border-b-2 ${view === 'watchlist' ? 'border-purple-600 text-purple-700' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                                >
                                    Watchlist
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 fade-in">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
                            {view === 'holdings' ? renderPortfolioTable() : renderWatchlistTable()}
                            
                            {/* Empty State */}
                            {((view === 'holdings' && portfolio.length === 0) || (view === 'watchlist' && watchlist.length === 0)) && (
                                <div className="text-center py-20 text-slate-400">
                                    <div className="mx-auto bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                                        <Icon name="inbox" size={32}/>
                                    </div>
                                    <p>Список порожній. Додайте свій перший актив.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-slate-900">
                                        {editingItem ? 'Редагувати' : 'Додати'} {formData.type === 'holdings' ? 'Актив' : 'у Watchlist'}
                                    </h3>
                                    <button onClick={closeModal} className="text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 mb-1">Символ (Ticker)</label>
                                            <input 
                                                type="text" 
                                                value={formData.ticker}
                                                onChange={e => setFormData({...formData, ticker: e.target.value})}
                                                className="w-full border border-slate-300 rounded-lg p-2.5 text-sm uppercase focus:ring-2 focus:ring-purple-500 outline-none"
                                                placeholder="AAPL"
                                                autoFocus
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 mb-1">Назва (опційно)</label>
                                            <input 
                                                type="text" 
                                                value={formData.name}
                                                onChange={e => setFormData({...formData, name: e.target.value})}
                                                className="w-full border border-slate-300 rounded-lg p-2.5 text-sm"
                                                placeholder="Apple Inc"
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 mb-1">Сектор</label>
                                        <select 
                                            value={formData.sector} 
                                            onChange={e => setFormData({...formData, sector: e.target.value})}
                                            className="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white"
                                        >
                                            <option value="">Інше</option>
                                            <option value="Technology">Technology</option>
                                            <option value="Communication">Communication</option>
                                            <option value="Software">Software</option>
                                            <option value="Hardware">Hardware</option>
                                            <option value="Semiconductors">Semiconductors</option>
                                            <option value="Consumer">Consumer</option>
                                        </select>
                                    </div>

                                    {formData.type === 'holdings' && (
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-semibold text-slate-500 mb-1">Кількість (Qty)</label>
                                                <input 
                                                    type="number" 
                                                    value={formData.qty}
                                                    onChange={e => setFormData({...formData, qty: e.target.value})}
                                                    className="w-full border border-slate-300 rounded-lg p-2.5 text-sm"
                                                    placeholder="0"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-semibold text-slate-500 mb-1">Ціна входу (Avg)</label>
                                                <input 
                                                    type="number" 
                                                    value={formData.price}
                                                    onChange={e => setFormData({...formData, price: e.target.value})}
                                                    className="w-full border border-slate-300 rounded-lg p-2.5 text-sm"
                                                    placeholder="0.00"
                                                />
                                            </div>
                                        </div>
                                    )}

                                    {formData.type === 'watchlist' && (
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 mb-1">Цільова ціна (Target)</label>
                                            <input 
                                                type="number" 
                                                value={formData.price}
                                                onChange={e => setFormData({...formData, price: e.target.value})}
                                                className="w-full border border-slate-300 rounded-lg p-2.5 text-sm"
                                                placeholder="0.00"
                                            />
                                        </div>
                                    )}

                                    <button 
                                        onClick={handleSaveAsset}
                                        className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg text-sm mt-4 transition shadow-md"
                                    >
                                        Зберегти
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
