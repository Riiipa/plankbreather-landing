import React, { useState, useMemo } from 'react';
import { 
    Briefcase, 
    Search, 
    Wallet, 
    TrendingUp, 
    PieChart, 
    Eye, 
    Download, 
    Lightbulb,
    ArrowUp,
    ArrowDown
} from 'lucide-react';

// --- MOCK DATA (Based on your CSV files) ---
const PORTFOLIO_DATA = [
    { ticker: "GOOGL", name: "Alphabet Inc Class A", qty: 8, avgPrice: 165.82, currPrice: 314.09, sector: "Communication Services" },
    { ticker: "AMAT", name: "Applied Materials Inc", qty: 5, avgPrice: 198.29, currPrice: 260.78, sector: "Technology" },
    { ticker: "WDC", name: "Western Digital Corp", qty: 3, avgPrice: 30.75, currPrice: 179.56, sector: "Technology" },
    { ticker: "QCOM", name: "Qualcomm Inc", qty: 2, avgPrice: 136.28, currPrice: 174.77, sector: "Technology" },
    { ticker: "NVDA", name: "NVIDIA Corp", qty: 3, avgPrice: 134.52, currPrice: 188.61, sector: "Technology" },
    { ticker: "TSM", name: "Taiwan Semiconductor", qty: 5, avgPrice: 90.83, currPrice: 145.20, sector: "Technology" }
];

const WATCHLIST_DATA = [
    { ticker: "STX", name: "Seagate Technology", marketCap: "62.15B", low52: 63.19, high52: 308.93, currPrice: 285.27, sector: "Tech Hardware" },
    { ticker: "WDC", name: "Western Digital Corp", marketCap: "61.39B", low52: 28.83, high52: 188.77, currPrice: 179.56, sector: "Tech Hardware" },
    { ticker: "SNDK", name: "SanDisk Corp", marketCap: "36.65B", low52: 27.89, high52: 284.76, currPrice: 250.08, sector: "Tech Hardware" },
    { ticker: "INTC", name: "Intel Corp", marketCap: "172.48B", low52: 17.67, high52: 44.01, currPrice: 36.16, sector: "Semiconductors" },
    { ticker: "AVGO", name: "Broadcom Inc", marketCap: "1.66T", low52: 800.00, high52: 1400.00, currPrice: 1350.00, sector: "Semiconductors" },
    { ticker: "MSFT", name: "Microsoft Corp", marketCap: "3.6T", low52: 344.79, high52: 555.45, currPrice: 488.02, sector: "Software" },
    { ticker: "AAPL", name: "Apple Inc", marketCap: "4.0T", low52: 169.21, high52: 288.61, currPrice: 273.81, sector: "Consumer Electronics" },
    { ticker: "AMD", name: "Advanced Micro Devices", marketCap: "350.1B", low52: 76.48, high52: 267.08, currPrice: 215.04, sector: "Semiconductors" },
    { ticker: "AMZN", name: "Amazon.com Inc", marketCap: "2.48T", low52: 161.43, high52: 258.60, currPrice: 232.38, sector: "Consumer Disc." }
];

// --- COMPONENTS ---

const MetricCard = ({ title, value, subValue, isPositive, Icon }) => (
    <div className="bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all duration-300">
        <div className="flex justify-between items-start mb-4">
            <div className={`p-3 rounded-xl ${isPositive ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`}>
                <Icon size={24} />
            </div>
            {subValue && (
                <span className={`text-sm font-semibold px-2 py-1 rounded-full flex items-center gap-1 ${isPositive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {isPositive ? <ArrowUp size={14}/> : <ArrowDown size={14}/>}
                    {subValue}
                </span>
            )}
        </div>
        <h3 className="text-slate-500 text-sm font-medium mb-1">{title}</h3>
        <p className="text-2xl font-bold text-slate-800">{value}</p>
    </div>
);

const Badge = ({ text }) => {
    const colors = {
        default: 'bg-slate-100 text-slate-700',
        tech: 'bg-indigo-100 text-indigo-700',
        comm: 'bg-purple-100 text-purple-700',
        consumer: 'bg-orange-100 text-orange-700'
    };
    
    let colorClass = colors.default;
    if (text.includes("Tech") || text.includes("Semi") || text.includes("Soft") || text.includes("Hardware")) colorClass = colors.tech;
    if (text.includes("Comm") || text.includes("Media")) colorClass = colors.comm;
    if (text.includes("Consumer")) colorClass = colors.consumer;

    return (
        <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}`}>
            {text}
        </span>
    );
};

const PortfolioTable = ({ data }) => {
    return (
        <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200">
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="border-b border-slate-100 bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                        <th className="p-4 font-semibold">Актив</th>
                        <th className="p-4 font-semibold">Сектор</th>
                        <th className="p-4 font-semibold text-right">К-сть</th>
                        <th className="p-4 font-semibold text-right">Вхід</th>
                        <th className="p-4 font-semibold text-right">Ціна</th>
                        <th className="p-4 font-semibold text-right">Вартість</th>
                        <th className="p-4 font-semibold text-right">P&L</th>
                    </tr>
                </thead>
                <tbody className="text-sm">
                    {data.map((item, idx) => {
                        const cost = item.qty * item.avgPrice;
                        const value = item.qty * item.currPrice;
                        const profit = value - cost;
                        const profitPercent = (profit / cost) * 100;
                        const isProfitable = profit >= 0;

                        return (
                            <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                <td className="p-4">
                                    <div className="font-bold text-slate-800">{item.ticker}</div>
                                    <div className="text-xs text-slate-500">{item.name}</div>
                                </td>
                                <td className="p-4"><Badge text={item.sector} /></td>
                                <td className="p-4 text-right text-slate-600 font-mono">{item.qty}</td>
                                <td className="p-4 text-right text-slate-600 font-mono">${item.avgPrice.toFixed(2)}</td>
                                <td className="p-4 text-right font-medium text-slate-800 font-mono">${item.currPrice.toFixed(2)}</td>
                                <td className="p-4 text-right font-bold text-slate-800 font-mono">${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td className="p-4 text-right">
                                    <div className={`font-bold font-mono ${isProfitable ? 'text-green-600' : 'text-red-500'}`}>
                                        {isProfitable ? '+' : ''}{profit.toFixed(2)} $
                                    </div>
                                    <div className={`text-xs ${isProfitable ? 'text-green-500' : 'text-red-400'}`}>
                                        {profitPercent.toFixed(2)}%
                                    </div>
                                </td>
                            </tr>
                        );
                    })}
                </tbody>
            </table>
        </div>
    );
};

const WatchlistTable = ({ data }) => {
    return (
        <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200">
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="border-b border-slate-100 bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                        <th className="p-4 font-semibold">Тікер</th>
                        <th className="p-4 font-semibold">Сектор</th>
                        <th className="p-4 font-semibold text-right">Ціна</th>
                        <th className="p-4 font-semibold text-right">Капіталізація</th>
                        <th className="p-4 font-semibold text-center">Діапазон 52 тижні</th>
                        <th className="p-4 font-semibold text-right">Дія</th>
                    </tr>
                </thead>
                <tbody className="text-sm">
                    {data.map((item, idx) => {
                        // Progress bar position for 52 week range
                        const range = item.high52 - item.low52;
                        const position = ((item.currPrice - item.low52) / range) * 100;
                        const safePosition = Math.min(100, Math.max(0, position));

                        return (
                            <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                <td className="p-4">
                                    <div className="font-bold text-slate-800">{item.ticker}</div>
                                    <div className="text-xs text-slate-500">{item.name}</div>
                                </td>
                                <td className="p-4"><Badge text={item.sector} /></td>
                                <td className="p-4 text-right font-bold text-slate-800 font-mono">${item.currPrice.toFixed(2)}</td>
                                <td className="p-4 text-right text-slate-600 font-mono">{item.marketCap}</td>
                                <td className="p-4 w-48">
                                    <div className="flex justify-between text-[10px] text-slate-400 mb-1 font-mono">
                                        <span>L: {item.low52}</span>
                                        <span>H: {item.high52}</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-1.5 relative">
                                        <div 
                                            className="bg-blue-500 h-1.5 rounded-full absolute transition-all duration-1000" 
                                            style={{ width: '8px', left: `${safePosition}%`, transform: 'translateX(-50%)' }}
                                        ></div>
                                    </div>
                                </td>
                                <td className="p-4 text-right">
                                    <button className="px-3 py-1.5 bg-slate-800 text-white text-xs font-medium rounded-lg hover:bg-blue-600 transition-colors shadow-sm">
                                        Аналіз
                                    </button>
                                </td>
                            </tr>
                        );
                    })}
                </tbody>
            </table>
        </div>
    );
};

export default function App() {
    const [activeTab, setActiveTab] = useState('portfolio');
    const [searchTerm, setSearchTerm] = useState('');

    // Calculations
    const totalCost = useMemo(() => PORTFOLIO_DATA.reduce((acc, item) => acc + (item.qty * item.avgPrice), 0), []);
    const totalValue = useMemo(() => PORTFOLIO_DATA.reduce((acc, item) => acc + (item.qty * item.currPrice), 0), []);
    const totalProfit = totalValue - totalCost;
    const totalProfitPercent = (totalProfit / totalCost) * 100;

    const filteredPortfolio = useMemo(() => PORTFOLIO_DATA.filter(i => 
        i.ticker.toLowerCase().includes(searchTerm.toLowerCase()) || 
        i.name.toLowerCase().includes(searchTerm.toLowerCase())
    ), [searchTerm]);

    const filteredWatchlist = useMemo(() => WATCHLIST_DATA.filter(i => 
        i.ticker.toLowerCase().includes(searchTerm.toLowerCase()) || 
        i.name.toLowerCase().includes(searchTerm.toLowerCase())
    ), [searchTerm]);

    return (
        <div className="min-h-screen bg-slate-50 text-slate-900 font-sans">
            <div className="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                
                {/* Header */}
                <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                            <Briefcase className="text-blue-600" />
                            USD 2026 Portfolio
                        </h1>
                        <p className="text-slate-500 text-sm mt-1">Ваш шлях до фінансової незалежності</p>
                    </div>
                    <div className="relative group">
                        <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-blue-500 transition-colors" />
                        <input 
                            type="text" 
                            placeholder="Пошук (AMD, Google...)" 
                            className="pl-10 pr-4 py-2 bg-white rounded-xl shadow-sm border border-slate-200 outline-none text-sm text-slate-700 w-full md:w-64 focus:ring-2 focus:ring-blue-100 transition-all"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>
                </header>

                {/* Navigation Tabs */}
                <div className="flex gap-6 mb-8 border-b border-slate-200">
                    <button 
                        onClick={() => setActiveTab('portfolio')}
                        className={`pb-3 px-1 text-sm font-semibold transition-all relative ${activeTab === 'portfolio' ? 'text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                    >
                        Мій Портфель
                        {activeTab === 'portfolio' && <div className="absolute -bottom-px left-0 w-full h-0.5 bg-blue-600 rounded-t-full"></div>}
                    </button>
                    <button 
                        onClick={() => setActiveTab('watchlist')}
                        className={`pb-3 px-1 text-sm font-semibold transition-all relative flex items-center gap-2 ${activeTab === 'watchlist' ? 'text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                    >
                        <Eye size={16}/> Watchlist (Спостереження)
                        {activeTab === 'watchlist' && <div className="absolute -bottom-px left-0 w-full h-0.5 bg-blue-600 rounded-t-full"></div>}
                    </button>
                </div>

                {/* Main Content */}
                <main>
                    {/* Summary Metrics */}
                    {activeTab === 'portfolio' && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <MetricCard 
                                title="Загальна вартість" 
                                value={`$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`} 
                                Icon={Wallet}
                                isPositive={true}
                            />
                            <MetricCard 
                                title="Загальний прибуток" 
                                value={`$${totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2})}`} 
                                subValue={`${totalProfitPercent.toFixed(2)}%`}
                                isPositive={totalProfit >= 0}
                                Icon={TrendingUp}
                            />
                            <MetricCard 
                                title="Кількість активів" 
                                value={PORTFOLIO_DATA.length}
                                Icon={PieChart}
                                isPositive={true}
                            />
                        </div>
                    )}

                    {activeTab === 'portfolio' ? (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    Поточні активи <span className="bg-slate-100 text-slate-500 text-xs py-0.5 px-2 rounded-full">{filteredPortfolio.length}</span>
                                </h2>
                                <button className="text-sm text-slate-600 font-medium hover:text-blue-600 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-blue-50">
                                    <Download size={16}/> Експорт CSV
                                </button>
                            </div>
                            <PortfolioTable data={filteredPortfolio} />
                        </div>
                    ) : (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div className="bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-100 p-5 rounded-xl mb-6 flex gap-4 items-start shadow-sm">
                                <div className="bg-white p-2.5 rounded-lg text-indigo-600 shadow-sm">
                                    <Lightbulb size={20} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-indigo-900 text-sm mb-1">Зона аналізу</h3>
                                    <p className="text-xs text-indigo-700 leading-relaxed max-w-2xl">
                                        Тут знаходяться акції, які ви відібрали для потенційної покупки. 
                                        Слідкуйте за індикатором <span className="font-semibold">"Діапазон 52 тижні"</span>: якщо синій маркер зліва — ціна біля річного мінімуму (потенційно гарна точка входу).
                                    </p>
                                </div>
                            </div>
                            <WatchlistTable data={filteredWatchlist} />
                        </div>
                    )}
                </main>
            </div>
        </div>
    );
}
