<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій Інвестиційний Портфель (Live)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ПОЧАТКОВІ ДАНІ (З ВАШИХ ФАЙЛІВ) ---
        // Ці дані будуть використані, якщо немає підключення до Google Sheet
        const INITIAL_PORTFOLIO = [
            { ticker: "GOOGL", name: "Alphabet Inc", qty: 8, avgPrice: 165.82, currPrice: 314.09, sector: "Communication" },
            { ticker: "AMAT", name: "Applied Materials", qty: 5, avgPrice: 198.29, currPrice: 260.78, sector: "Technology" },
            { ticker: "WDC", name: "Western Digital", qty: 3, avgPrice: 30.75, currPrice: 179.56, sector: "Technology" },
            { ticker: "QCOM", name: "Qualcomm Inc", qty: 2, avgPrice: 136.28, currPrice: 174.77, sector: "Technology" },
            { ticker: "NVDA", name: "NVIDIA Corp", qty: 3, avgPrice: 134.52, currPrice: 188.61, sector: "Technology" },
            { ticker: "TSM", name: "Taiwan Semi", qty: 5, avgPrice: 90.83, currPrice: 145.20, sector: "Technology" }
        ];

        const INITIAL_WATCHLIST = [
            { ticker: "STX", name: "Seagate Tech", marketCap: "62B", targetPrice: 285.00, currPrice: 285.27, sector: "Hardware" },
            { ticker: "SNDK", name: "SanDisk Corp", marketCap: "36B", targetPrice: 250.00, currPrice: 250.08, sector: "Hardware" },
            { ticker: "INTC", name: "Intel Corp", marketCap: "172B", targetPrice: 40.00, currPrice: 36.16, sector: "Semiconductors" },
            { ticker: "AVGO", name: "Broadcom Inc", marketCap: "1.6T", targetPrice: 1400.00, currPrice: 1350.00, sector: "Semiconductors" },
            { ticker: "MSFT", name: "Microsoft", marketCap: "3.6T", targetPrice: 500.00, currPrice: 488.02, sector: "Software" },
            { ticker: "AAPL", name: "Apple Inc", marketCap: "4T", targetPrice: 280.00, currPrice: 273.81, sector: "Electronics" },
            { ticker: "AMD", name: "AMD Inc", marketCap: "350B", targetPrice: 220.00, currPrice: 215.04, sector: "Semiconductors" },
            { ticker: "AMZN", name: "Amazon", marketCap: "2.5T", targetPrice: 240.00, currPrice: 232.38, sector: "Consumer" }
        ];

        // --- КОМПОНЕНТИ ---

        const Icon = ({ name, size = 20, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-5 ${className}`}>{children}</div>
        );

        const Badge = ({ text }) => {
            let color = "bg-slate-100 text-slate-600";
            if (["Technology", "Semiconductors", "Software"].includes(text)) color = "bg-blue-100 text-blue-700";
            if (["Communication", "Consumer"].includes(text)) color = "bg-purple-100 text-purple-700";
            if (["Hardware", "Electronics"].includes(text)) color = "bg-orange-100 text-orange-700";
            return <span className={`px-2 py-1 rounded text-xs font-medium ${color}`}>{text}</span>;
        };

        // --- ГОЛОВНИЙ ДОДАТОК ---

        const App = () => {
            const [view, setView] = useState("portfolio"); // portfolio | watchlist
            const [portfolio, setPortfolio] = useState(INITIAL_PORTFOLIO);
            const [watchlist, setWatchlist] = useState(INITIAL_WATCHLIST);
            const [sheetUrl, setSheetUrl] = useState("");
            const [lastUpdated, setLastUpdated] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAddAssetOpen, setIsAddAssetOpen] = useState(false);
            
            // Стан для нового активу
            const [newAsset, setNewAsset] = useState({ ticker: "", qty: "", price: "", type: "portfolio" });

            // --- ЛОГІКА ОНОВЛЕННЯ ДАНИХ ---
            const fetchSheetData = async () => {
                if (!sheetUrl) return;
                try {
                    const response = await fetch(sheetUrl);
                    const csvText = await response.text();
                    
                    // Парсинг CSV (спрощений)
                    const rows = csvText.split('\n').map(row => row.split(','));
                    
                    // Створюємо мапу цін: { "AAPL": 150.20, "GOOGL": 200.50 }
                    // Припускаємо, що в Google Sheet колонка A = Тікер, B = Ціна
                    const priceMap = {};
                    rows.forEach(row => {
                        if (row[0] && row[1]) {
                            const ticker = row[0].trim().toUpperCase();
                            const price = parseFloat(row[1].replace(/[^0-9.]/g, ''));
                            if (!isNaN(price)) priceMap[ticker] = price;
                        }
                    });

                    if (Object.keys(priceMap).length > 0) {
                        // Оновлюємо Портфель
                        setPortfolio(prev => prev.map(item => ({
                            ...item,
                            currPrice: priceMap[item.ticker] || item.currPrice
                        })));
                        
                        // Оновлюємо Watchlist
                        setWatchlist(prev => prev.map(item => ({
                            ...item,
                            currPrice: priceMap[item.ticker] || item.currPrice
                        })));
                        
                        setLastUpdated(new Date());
                        alert(`Успішно оновлено ${Object.keys(priceMap).length} активів!`);
                        setIsSettingsOpen(false);
                    } else {
                        alert("Не вдалося знайти дані у CSV. Перевірте формат (Стовпчик A: Тікер, B: Ціна).");
                    }
                } catch (error) {
                    console.error(error);
                    alert("Помилка завантаження. Перевірте посилання (має бути 'Published to Web' CSV).");
                }
            };

            // --- ЛОГІКА ДОДАВАННЯ АКТИВУ ---
            const handleAddAsset = () => {
                if (!newAsset.ticker || !newAsset.price) return;
                
                const asset = {
                    ticker: newAsset.ticker.toUpperCase(),
                    name: "Новий Актив", // Можна додати поле для імені
                    currPrice: parseFloat(newAsset.price),
                    sector: "Other",
                    // Для портфеля
                    qty: parseFloat(newAsset.qty) || 0,
                    avgPrice: parseFloat(newAsset.price), // Припускаємо покупку по поточній
                    // Для вотчліста
                    marketCap: "-",
                    targetPrice: parseFloat(newAsset.price) * 0.9 
                };

                if (newAsset.type === 'portfolio') {
                    setPortfolio([...portfolio, asset]);
                } else {
                    setWatchlist([...watchlist, asset]);
                }
                setIsAddAssetOpen(false);
                setNewAsset({ ticker: "", qty: "", price: "", type: "portfolio" });
            };

            // --- РОЗРАХУНКИ ---
            const totalInvested = portfolio.reduce((acc, item) => acc + (item.qty * item.avgPrice), 0);
            const currentValue = portfolio.reduce((acc, item) => acc + (item.qty * item.currPrice), 0);
            const totalProfit = currentValue - totalInvested;
            const profitPercent = totalInvested > 0 ? (totalProfit / totalInvested) * 100 : 0;

            // --- РЕНДЕР ---
            return (
                <div className="min-h-screen pb-10">
                    {/* НАВІГАЦІЯ */}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 text-slate-800 font-bold text-xl">
                                <div className="p-2 bg-blue-600 rounded-lg text-white">
                                    <Icon name="trending-up" size={20} />
                                </div>
                                InvestPro 2026
                            </div>
                            
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setIsAddAssetOpen(true)}
                                    className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition"
                                >
                                    <Icon name="plus-circle" size={16} /> Додати Актив
                                </button>
                                <button 
                                    onClick={() => setIsSettingsOpen(true)}
                                    className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition"
                                >
                                    <Icon name="link" size={16} /> Data Source
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-6xl mx-auto px-4 sm:px-6 mt-8">
                        
                        {/* ГОЛОВНИЙ ДАШБОРД */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
                            <Card className="bg-gradient-to-br from-blue-600 to-blue-700 text-white border-none">
                                <div className="flex justify-between items-start mb-4 opacity-80">
                                    <span className="text-sm font-medium">Поточний баланс</span>
                                    <Icon name="wallet" />
                                </div>
                                <div className="text-3xl font-bold mb-1">${currentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                                <div className="text-blue-100 text-sm">Вкладено: ${totalInvested.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                            </Card>

                            <Card>
                                <div className="flex justify-between items-start mb-4">
                                    <span className="text-sm font-medium text-slate-500">P&L (Прибуток)</span>
                                    <div className={`p-2 rounded-lg ${totalProfit >= 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        <Icon name={totalProfit >= 0 ? "arrow-up-right" : "arrow-down-right"} />
                                    </div>
                                </div>
                                <div className={`text-3xl font-bold mb-1 ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {totalProfit >= 0 ? '+' : ''}{totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2})} $
                                </div>
                                <div className={`text-sm font-medium ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {totalProfit >= 0 ? '+' : ''}{profitPercent.toFixed(2)}%
                                </div>
                            </Card>

                            <Card>
                                <div className="flex justify-between items-start mb-4">
                                    <span className="text-sm font-medium text-slate-500">Статус даних</span>
                                    <div className="p-2 bg-slate-100 text-slate-600 rounded-lg">
                                        <Icon name="database" />
                                    </div>
                                </div>
                                <div className="text-lg font-semibold text-slate-800 mb-1">
                                    {lastUpdated ? "Live Data" : "Static Data"}
                                </div>
                                <div className="text-xs text-slate-400">
                                    {lastUpdated ? `Оновлено: ${lastUpdated.toLocaleTimeString()}` : "Підключіть Google Sheet для оновлення"}
                                </div>
                            </Card>
                        </div>

                        {/* ТАБИ */}
                        <div className="flex border-b border-slate-200 mb-6">
                            <button 
                                onClick={() => setView('portfolio')}
                                className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${view === 'portfolio' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                            >
                                Мій Портфель ({portfolio.length})
                            </button>
                            <button 
                                onClick={() => setView('watchlist')}
                                className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${view === 'watchlist' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                            >
                                Watchlist ({watchlist.length})
                            </button>
                        </div>

                        {/* ТАБЛИЦЯ ПОРТФЕЛЮ */}
                        {view === 'portfolio' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-slate-50 text-slate-500 text-xs uppercase">
                                        <tr>
                                            <th className="p-4 font-semibold">Тікер</th>
                                            <th className="p-4 font-semibold">Сектор</th>
                                            <th className="p-4 font-semibold text-right">К-сть</th>
                                            <th className="p-4 font-semibold text-right">Сер. Вхід</th>
                                            <th className="p-4 font-semibold text-right">Ціна</th>
                                            <th className="p-4 font-semibold text-right">Позиція</th>
                                            <th className="p-4 font-semibold text-right">Прибуток</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 text-sm">
                                        {portfolio.map((item, i) => {
                                            const cost = item.qty * item.avgPrice;
                                            const val = item.qty * item.currPrice;
                                            const prof = val - cost;
                                            const profPerc = (prof / cost) * 100;
                                            return (
                                                <tr key={i} className="hover:bg-slate-50 transition">
                                                    <td className="p-4">
                                                        <div className="font-bold text-slate-800">{item.ticker}</div>
                                                        <div className="text-xs text-slate-500">{item.name}</div>
                                                    </td>
                                                    <td className="p-4"><Badge text={item.sector}/></td>
                                                    <td className="p-4 text-right text-slate-600">{item.qty}</td>
                                                    <td className="p-4 text-right text-slate-600">${item.avgPrice.toFixed(2)}</td>
                                                    <td className="p-4 text-right font-medium text-slate-900">${item.currPrice.toFixed(2)}</td>
                                                    <td className="p-4 text-right font-bold text-slate-900">${val.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                                                    <td className="p-4 text-right">
                                                        <div className={prof >= 0 ? "text-green-600 font-bold" : "text-red-600 font-bold"}>
                                                            {prof >= 0 ? '+' : ''}{prof.toFixed(0)} $
                                                        </div>
                                                        <div className={prof >= 0 ? "text-green-500 text-xs" : "text-red-500 text-xs"}>
                                                            {profPerc.toFixed(2)}%
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* ТАБЛИЦЯ WATCHLIST */}
                        {view === 'watchlist' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                                <div className="p-4 bg-yellow-50 border-b border-yellow-100 text-yellow-800 text-sm flex gap-2">
                                    <Icon name="info" size={18}/>
                                    <span>Тут акції, які ви аналізуєте для покупки. Ціни оновлюються через Google Sheet.</span>
                                </div>
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-slate-50 text-slate-500 text-xs uppercase">
                                        <tr>
                                            <th className="p-4 font-semibold">Тікер</th>
                                            <th className="p-4 font-semibold">Сектор</th>
                                            <th className="p-4 font-semibold text-right">Ціна</th>
                                            <th className="p-4 font-semibold text-right">Цільова ціна</th>
                                            <th className="p-4 font-semibold text-right">Капіталізація</th>
                                            <th className="p-4 font-semibold text-right">Дія</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 text-sm">
                                        {watchlist.map((item, i) => (
                                            <tr key={i} className="hover:bg-slate-50 transition">
                                                <td className="p-4">
                                                    <div className="font-bold text-slate-800">{item.ticker}</div>
                                                    <div className="text-xs text-slate-500">{item.name}</div>
                                                </td>
                                                <td className="p-4"><Badge text={item.sector}/></td>
                                                <td className="p-4 text-right font-bold text-slate-900">${item.currPrice.toFixed(2)}</td>
                                                <td className="p-4 text-right text-slate-600">${item.targetPrice.toFixed(2)}</td>
                                                <td className="p-4 text-right text-slate-600">{item.marketCap}</td>
                                                <td className="p-4 text-right">
                                                    <button className="text-blue-600 hover:underline text-xs font-medium">Аналіз</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                    </div>

                    {/* МОДАЛКА: DATA SOURCE */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-800">Підключення Live Даних</h3>
                                    <button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                                </div>
                                <p className="text-sm text-slate-600 mb-4">
                                    Щоб отримати актуальні ціни, створіть Google Sheet з колонками: 
                                    <br/><code className="bg-slate-100 p-1 rounded text-xs">A: Ticker (GOOGL)</code>, <code className="bg-slate-100 p-1 rounded text-xs">B: Price (=GOOGLEFINANCE("GOOGL"))</code>.
                                    <br/>Далі: File -> Share -> Publish to web (CSV).
                                </p>
                                <input 
                                    type="text" 
                                    className="w-full border border-slate-300 rounded-lg p-3 text-sm mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                                    placeholder="Вставте посилання на CSV тут..."
                                    value={sheetUrl}
                                    onChange={(e) => setSheetUrl(e.target.value)}
                                />
                                <button 
                                    onClick={fetchSheetData}
                                    className="w-full bg-blue-600 text-white font-medium py-2 rounded-lg hover:bg-blue-700 transition flex justify-center gap-2"
                                >
                                    <Icon name="refresh-cw" size={18}/> Завантажити дані
                                </button>
                            </div>
                        </div>
                    )}

                    {/* МОДАЛКА: ADD ASSET */}
                    {isAddAssetOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-800">Додати Актив</h3>
                                    <button onClick={() => setIsAddAssetOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                                </div>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Куди додати?</label>
                                        <div className="flex bg-slate-100 p-1 rounded-lg">
                                            <button onClick={() => setNewAsset({...newAsset, type: 'portfolio'})} className={`flex-1 py-1 text-xs rounded-md font-medium transition ${newAsset.type === 'portfolio' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Портфель</button>
                                            <button onClick={() => setNewAsset({...newAsset, type: 'watchlist'})} className={`flex-1 py-1 text-xs rounded-md font-medium transition ${newAsset.type === 'watchlist' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Watchlist</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Тікер (напр. AAPL)</label>
                                        <input type="text" className="w-full border p-2 rounded-lg text-sm" value={newAsset.ticker} onChange={e => setNewAsset({...newAsset, ticker: e.target.value})} />
                                    </div>
                                    {newAsset.type === 'portfolio' && (
                                        <div>
                                            <label className="block text-xs font-medium text-slate-500 mb-1">Кількість</label>
                                            <input type="number" className="w-full border p-2 rounded-lg text-sm" value={newAsset.qty} onChange={e => setNewAsset({...newAsset, qty: e.target.value})} />
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Ціна (Поточна/Входу)</label>
                                        <input type="number" className="w-full border p-2 rounded-lg text-sm" value={newAsset.price} onChange={e => setNewAsset({...newAsset, price: e.target.value})} />
                                    </div>
                                    
                                    <button onClick={handleAddAsset} className="w-full bg-slate-900 text-white py-2 rounded-lg text-sm font-medium mt-2">Зберегти</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
